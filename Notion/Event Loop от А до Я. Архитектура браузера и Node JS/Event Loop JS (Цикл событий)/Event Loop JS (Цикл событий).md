![[Untitled 82.png|Untitled 82.png]]

В JavaScript **event loop (цикл событий)** является ключевым механизмом для обеспечения асинхронной работы кода.

**Event loop** работает внутри браузера или среды Node.js и следит за событиями в двух основных очередях:

1. **Call Stack (стек вызовов)**: это место, где вызываются функции в процессе выполнения программы. Когда функция вызывается, она помещается в стек вызовов, а когда она завершается, она удаляется из стека.
2. **Task Queue (очередь задач)**: это место, где хранятся события, которые ждут своей очереди на выполнение. Когда функция асинхронной операции завершается, соответствующее событие помещается в очередь задач.

**Event loop** постоянно мониторит **стек вызовов** и **очередь задач**. Если стек вызовов пуст, то event loop извлекает следующее событие из очереди задач и помещает его в стек вызовов для выполнения. Таким образом, JavaScript позволяет выполнять код асинхронно и не блокируя основной поток исполнения, что позволяет обрабатывать большое количество запросов и событий в веб-приложениях.

> [!important]  
> За Task Queue (очередь задач) отвечает - Event loop, а за Call Stack (стек вызовов) - отвечает движок JS (V8 - Chrome, JavaScriptCore - Safari, Chakra Microsoft Edge, SpiderMonkey - Mozilla firefox)  
  
> [!important]  
> Event loop - не является частью движков JS. Event loop - предоставляется средой, это может-быть браузер, Node JS или какая-либо другая среда разработки, в которой этот Event loop требуется. И устройство Event loop - тоже может-быть разное.  

---

- А какие задачи решает **движок JS**?
    
    Движок JavaScript - это программное обеспечение, которое выполняет JavaScript-код. Движок JavaScript обычно встроен в браузер или среду выполнения JavaScript, такую как Node.js, и он выполняет ряд задач, необходимых для работы JavaScript-приложений:
    
    1. Парсинг и компиляция: движок JavaScript парсит JavaScript-код, превращая его в AST (абстрактное синтаксическое дерево) и компилирует его в машинный код, который может быть выполнен на целевой платформе.
    2. Управление памятью: движок JavaScript отвечает за управление памятью, выделяемой для хранения данных JavaScript-приложений. Это включает в себя выделение памяти для переменных, объектов, массивов и функций, а также освобождение памяти, которая больше не используется.
    3. Выполнение кода: движок JavaScript выполняет JavaScript-код, включая операции с переменными, функциями, объектами, массивами и другими структурами данных.
    4. Управление сборкой мусора: JavaScript-приложения создают мусор, который может накапливаться в памяти. Движок JavaScript отвечает за сборку мусора и освобождение памяти, которая больше не используется.
    5. Обработка ошибок: JavaScript-код может содержать ошибки, такие как синтаксические ошибки, ошибки времени выполнения или ошибки, связанные с доступом к данным. Движок JavaScript отлавливает и обрабатывает ошибки, чтобы приложение не завершалось с ошибкой.
    6. Работа с DOM: браузерный движок JavaScript обычно отвечает за взаимодействие с DOM (объектной моделью документа), позволяя JavaScript-приложениям изменять содержимое и структуру веб-страницы.
    7. Работа с событиями: движок JavaScript обрабатывает события, такие как клики мыши или нажатия клавиш, и запускает соответствующие обработчики событий в JavaScript-приложении.
    
    В целом, движок JavaScript решает множество задач, связанных с компиляцией, выполнением и управлением JavaScript-кодом, что позволяет JavaScript-приложениям работать в браузере и на сервере.
    
- А какую роль в **Event Loop** играет **Web API**?
    
    **Web API (интерфейсы программирования приложений)** - это наборы функций и методов, которые предоставляются браузером для работы с веб-страницами и сетевыми запросами. Они позволяют JavaScript-коду взаимодействовать с веб-страницами и выполнять асинхронные задачи, такие как таймеры и сетевые запросы.
    
    **Web API** играет важную роль в цикле событий **Event Loop**. Когда асинхронная задача создается в JavaScript, она отправляется в **Web API** для выполнения. **Web API** выполняет задачу асинхронно и помещает ее в **очередь задач (Task Queue)**, когда задача выполнена.
    
    Например, если JavaScript-код использует таймер setInterval() для выполнения задачи через определенный интервал времени, браузер создает таймер, используя соответствующий метод из **Web API**. Когда интервал истекает, браузер помещает задачу в очередь задач, которая затем обрабатывается в цикле событий.
    
    Таким образом, **Web API** позволяет JavaScript-коду выполнять асинхронные задачи и взаимодействовать с веб-страницами, тогда как цикл событий **Event Loop** обеспечивает обработку задач в определенном порядке и управляет выполнением кода JavaScript.
    

---

### **Task Queue - Microtask and Macrotask**

**Microtask** и **Macrotask** — это два типа задач, которые используются в JavaScript для управления асинхронными операциями и выполнения кода в определенной последовательности.

**Macrotask**:  
Макротаски — это более крупные и общие задачи, которые добавляются в очередь задач (Task Queue). Примеры макротасок включают:  

1. setTimeout
2. setInterval
3. setImmediate (Node.js)
4. requestAnimationFrame (в основном используется в браузере для анимаций)

**Microtask:  
  
**Микротаски — это мельчайшие задачи, которые добавляются в отдельную очередь, называемую микроочередью (Microtask Queue). Микротаски обрабатываются быстрее, чем макротаски, поскольку выполняются сразу после завершения текущего синхронного кода и перед тем, как браузер обновляет свое состояние или вызывает любые другие коллбэки. Примеры микротасок включают:

1. Promise.then()
2. process.nextTick (Node.js)
3. MutationObserver (браузер)

Порядок выполнения **микротасок** и **макротасок**:  
Когда движок JavaScript выполняет асинхронный код, он сначала выполняет весь синхронный код. Затем, прежде чем перейти к макротаскам, он обрабатывает все микротаски в очереди микротасок. После выполнения всех микротасок движок переходит к макротаскам в очереди задач и начинает их выполнение. После завершения каждой макротаски, движок снова проверяет очередь микротасок и выполняет их, прежде чем перейти к следующей макротаске.  

Это гарантирует, что микротаски выполняются с приоритетом и обрабатываются быстрее, чем макротаски.

`**queueMicrotask()**`- это метод в JavaScript, который позволяет добавлять микрозадачи (microtask) в очередь.

---

- Что такое MutationObserver?
    
    `**MutationObserver**` - это API в JavaScript, который позволяет отслеживать изменения в DOM-структуре и реагировать на них.
    
    `**MutationObserver**` работает путем регистрации наблюдателя (observer) за определенным элементом DOM-структуры или за всем ее деревом. Наблюдатель получает уведомления о любых изменениях в DOM-структуре, таких как добавление, удаление или изменение элементов, изменение атрибутов элементов и т.д.
    
    Когда происходят изменения, `**MutationObserver**` создает объект `**MutationRecord**`, который содержит информацию о произошедших изменениях. Затем он вызывает колбэк-функцию (callback function), которая была зарегистрирована при создании `**MutationObserver**`. Колбэк-функция может обрабатывать полученные `**MutationRecord**` и реагировать на изменения в соответствии с требованиями приложения.
    
    `**MutationObserver**` может быть полезен для мониторинга изменений в DOM-структуре, например, для автоматического обновления пользовательского интерфейса при изменении данных или для отслеживания изменений в рекламных блоках на странице. Он может также использоваться для оптимизации производительности, например, для отложенной загрузки содержимого, пока не будет готова соответствующая область на странице.